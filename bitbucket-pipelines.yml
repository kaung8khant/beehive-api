# Template PHP Build

# This template allows you to validate your PHP application.
# The workflow allows running tests and code linting on the default branch.

image: composer:2.0

pipelines:
  branches:
    staging:
      - step:
          name: "Package Project"
          # Track staging environments builds using deployments.
          deployment: Staging
          script:
            # copy env file
            - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - cp .env.example .env
            - curl -o dotenv https://raw.githubusercontent.com/bashup/dotenv/master/dotenv
            - chmod +x dotenv
            - ./dotenv -f .env set APP_NAME=blablatest APP_KEY=${APP_KEY} JWT_SECRET=${JWT_SECRET}
            # install dependencies
            - composer install
            - php artisan l5-swagger:generate
            - mkdir -p public/docs
            - cp storage/api-docs/api-docs.json public/docs/api-docs.json
            - php artisan config:cache
            - php artisan route:cache
            - zip -r application.zip . -x "vendor/*"
          caches:
            - composer
          # Define an artifact to pass the zip file to the next step
          artifacts:
            - application.zip
      - step:
          name: "Deploy to Staging"
          script:
            - pipe: atlassian/aws-elasticbeanstalk-deploy:0.7.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: "ap-southeast-1"
                APPLICATION_NAME: "Beehive API Production"
                # APPLICATION_NAME: "beehive-api-production"
                ENVIRONMENT_NAME: "beehive-api-production-env"
                ZIP_FILE: "application.zip"
                S3_BUCKET: "elasticbeanstalk-ap-southeast-1-565186916354"
                VERSION_LABEL: "beehive-$BITBUCKET_BRANCH-$BITBUCKET_COMMIT-$BITBUCKET_BUILD_NUMBER"
